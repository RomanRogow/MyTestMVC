<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Список сотрудников</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .status-running { color: #ffc107; }
        .status-completed { color: #198754; }
        .status-failed { color: #dc3545; }
        .status-not-started { color: #6c757d; }
    </style>
</head>
<body>
<!-- Форма для обновления страницы -->
<form th:action="@{/employees/list}" method="get" style="display: none;" id="refreshForm"></form>

<div class="container mt-5">
    <h1><i class="bi bi-people"></i> Список сотрудников</h1>

    <!-- Сообщения из flash атрибутов -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>Успех!</strong> <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Ошибка!</strong> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Статус синхронизации Kafka -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <span><i class="bi bi-info-circle"></i> Статус синхронизации Kafka</span>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshPage()">
                <i class="bi bi-arrow-clockwise"></i> Обновить
            </button>
        </div>
        <div class="card-body" th:if="${syncStatus != null}">
            <!-- Отладка -->
            <div style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: none;">
                <small class="text-muted">Отладка:</small>
                <small>Статус загружен:
                    running=<span th:text="${syncStatus.running}"></span>,
                    status=<span th:text="${syncStatus.status}"></span>,
                    processed=<span th:text="${syncStatus.processedCount}"></span>,
                    total=<span th:text="${syncStatus.totalCount}"></span>,
                    message=<span th:text="${syncStatus.message}"></span>
                </small>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <p><strong>Статус:</strong>
                        <span th:if="${syncStatus.running}" class="status-running">
                            <i class="bi bi-arrow-repeat"></i> ВЫПОЛНЯЕТСЯ
                        </span>
                        <span th:unless="${syncStatus.running}">
                            <span th:if="${syncStatus.status == 'COMPLETED'}" class="status-completed">
                                <i class="bi bi-check-circle"></i> ЗАВЕРШЕНО
                            </span>
                            <span th:if="${syncStatus.status == 'NOT_STARTED'}" class="status-not-started">
                                <i class="bi bi-dash-circle"></i> НЕ НАЧИНАЛОСЬ
                            </span>
                            <span th:if="${syncStatus.status == 'STARTING'}" class="status-running">
                                <i class="bi bi-hourglass-split"></i> ЗАПУСКАЕТСЯ
                            </span>
                            <span th:if="${syncStatus.status == 'RUNNING'}" class="status-running">
                                <i class="bi bi-arrow-repeat"></i> ВЫПОЛНЯЕТСЯ
                            </span>
                            <span th:if="${syncStatus.status == 'STOPPED' or syncStatus.status == 'STOPPING'}" class="status-failed">
                                <i class="bi bi-pause-circle"></i> ОСТАНОВЛЕНО
                            </span>
                            <span th:if="${syncStatus.status == 'FAILED'}" class="status-failed">
                                <i class="bi bi-x-circle"></i> ОШИБКА
                            </span>
                            <span th:if="${syncStatus.status == 'NO_DATA'}" class="status-not-started">
                                <i class="bi bi-database"></i> НЕТ ДАННЫХ
                            </span>
                            <span th:if="${syncStatus.status == 'DISABLED'}" class="status-not-started">
                                <i class="bi bi-toggle-off"></i> ОТКЛЮЧЕНО
                            </span>
                        </span>
                    </p>
                    <p th:if="${syncStatus.totalCount > 0 and syncStatus.processedCount > 0}">
                        <strong>Обработано:</strong>
                        <span th:text="${syncStatus.processedCount}"></span> из
                        <span th:text="${syncStatus.totalCount}"></span> сотрудников
                        <span th:if="${syncStatus.totalCount > 0}">
                            (<span th:text="${#numbers.formatDecimal(syncStatus.processedCount * 1.0 / syncStatus.totalCount * 100, 1, 1)}"></span>%)
                        </span>
                    </p>
                    <p th:if="${syncStatus.totalCount > 0 and syncStatus.processedCount == 0}">
                        <strong>Всего сотрудников:</strong>
                        <span th:text="${syncStatus.totalCount}"></span>
                    </p>
                    <p th:if="${syncStatus.message != null and !syncStatus.message.isEmpty()}">
                        <strong>Сообщение:</strong>
                        <span th:text="${syncStatus.message}"></span>
                    </p>
                </div>
                <div class="col-md-6 text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            th:disabled="${not syncStatus.running}"
                            onclick="stopSync()">
                        <i class="bi bi-stop-circle"></i> Остановить синхронизацию
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body" th:unless="${syncStatus != null}">
            <p class="text-muted"><i class="bi bi-info-circle"></i> Статус синхронизации не доступен</p>
            <small class="text-danger">Ошибка: syncStatus равен null</small>
        </div>
    </div>

    <!-- Кнопки действий -->
    <div class="mb-4">
        <!-- Используем Thymeleaf путь -->
        <a th:href="@{/employees/add}" class="btn btn-success me-2">
            <i class="bi bi-person-plus"></i> Добавить сотрудника
        </a>

        <!-- Кнопка массовой синхронизации -->
        <!-- Используем Thymeleaf путь -->
        <form th:action="@{/employees/trigger-bulk}" method="post" style="display: inline;">
            <button type="submit" class="btn btn-warning me-2"
                    th:disabled="${syncStatus != null and syncStatus.running}"
                    onclick="return confirm('Запустить массовую синхронизацию всех сотрудников в Kafka? Это займет несколько секунд.')">
                <i class="bi bi-cloud-arrow-up"></i>
                <span th:if="${syncStatus != null and syncStatus.running}">Синхронизация...</span>
                <span th:unless="${syncStatus != null and syncStatus.running}">Синхронизировать в Kafka</span>
            </button>
        </form>

        <!-- Индикатор выполнения -->
        <div id="syncProgress" class="mt-2" th:classappend="${syncStatus != null and syncStatus.running} ? '' : 'd-none'">
            <div class="progress" style="height: 20px;">
                <div id="syncProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar"
                     th:style="${syncStatus != null and syncStatus.totalCount > 0} ?
                     'width:' + ${syncStatus.processedCount * 1.0 / syncStatus.totalCount * 100} + '%' : 'width: 0%'"></div>
            </div>
            <small id="syncStatusText" class="text-muted">
                <span th:if="${syncStatus != null}">
                    <span th:text="${syncStatus.processedCount}"></span> / <span th:text="${syncStatus.totalCount}"></span>
                    <span th:if="${syncStatus.totalCount > 0}">
                        (<span th:text="${#numbers.formatDecimal(syncStatus.processedCount * 1.0 / syncStatus.totalCount * 100, 1, 1)}"></span>%)
                    </span>
                    <span th:unless="${syncStatus.totalCount > 0}">(0%)</span>
                </span>
            </small>
        </div>
    </div>

    <!-- Поиск сотрудника -->
    <div class="card mb-4">
        <div class="card-body">
            <h5><i class="bi bi-search"></i> Поиск сотрудника из удалённого сервиса:</h5>
            <!-- Используем Thymeleaf путь -->
            <form th:action="@{/employees/search}" method="get" class="row g-3">
                <div class="col-auto">
                    <input type="number" name="id" class="form-control" placeholder="Введите ID" required min="1">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Найти и сохранить
                    </button>
                </div>
            </form>
            <small class="text-muted">Сотрудник будет найден в удалённом сервисе и сохранён в вашу локальную БД</small>
        </div>
    </div>

    <!-- Таблица сотрудников -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-list"></i> Список сотрудников</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Имя</th>
                        <th>Фамилия</th>
                        <th>Возраст</th>
                        <th>Табельный номер</th>
                        <th>Отдел</th>
                        <th>Должность</th>
                        <th>QR-код</th>
                        <th>Действия</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="emp : ${employees}" th:class="${empStat.odd}? 'table-row-odd'">
                        <td th:text="${emp.id}"></td>
                        <td th:text="${emp.firstName}"></td>
                        <td th:text="${emp.lastName}"></td>
                        <td th:text="${emp.age}"></td>
                        <td>
                            <span th:if="${emp.personalCode}" th:text="${emp.personalCode}" class="badge bg-info"></span>
                            <span th:unless="${emp.personalCode}" class="text-muted">—</span>
                        </td>
                        <td><span class="badge bg-secondary" th:text="${emp.department}"></span></td>
                        <td>
                            <span th:if="${emp.post}" th:text="${emp.post}"></span>
                            <span th:unless="${emp.post}" class="text-muted">—</span>
                        </td>
                        <td>
                            <div class="text-center">
                                <!-- Используем Thymeleaf путь -->
                                <a th:href="@{'/employees/' + ${emp.id} + '/qrcode'}"
                                   target="_blank"
                                   class="d-block mb-1"
                                   title="Просмотреть QR-код">
                                    <img th:if="${emp.personalCode != null}"
                                         th:src="@{'/employees/' + ${emp.id} + '/qrcode'}"
                                         alt="QR Code"
                                         width="50"
                                         height="50"
                                         class="img-thumbnail qr-code-img"
                                         style="cursor: pointer;">
                                    <div th:unless="${emp.personalCode != null}"
                                         class="text-muted small">Нет QR</div>
                                </a>
                                <small class="text-muted">
                                    <!-- Используем Thymeleaf путь -->
                                    <a th:href="@{'/employees/' + ${emp.id} + '/qrcode'}"
                                       download="employee_${emp.personalCode}_qrcode.png"
                                       class="text-decoration-none"
                                       th:if="${emp.personalCode != null}">
                                        <i class="bi bi-download"></i> Скачать
                                    </a>
                                </small>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <!-- Используем Thymeleaf путь -->
                                <a th:href="@{'/employees/' + ${emp.id}}"
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-eye"></i> Просмотр
                                </a>
                                <!-- Используем Thymeleaf путь -->
                                <form th:action="@{'/employees/delete/' + ${emp.id}}"
                                      method="post"
                                      class="d-inline"
                                      th:attr="onsubmit='return confirmDelete(this, \'' + ${emp.firstName} + '\', \'' + ${emp.lastName} + '\')'">
                                    <button type="submit" class="btn btn-outline-danger btn-sm ms-1">
                                        <i class="bi bi-trash"></i> Удалить
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(employees)}">
                        <td colspan="9" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-people display-4 d-block mb-3"></i>
                                <h5>Нет сотрудников</h5>
                                <p class="mb-3">Добавьте первого сотрудника или найдите по ID в удалённом сервисе</p>
                                <!-- Используем Thymeleaf путь -->
                                <a th:href="@{/employees/add}" class="btn btn-primary">
                                    <i class="bi bi-person-plus"></i> Добавить первого сотрудника
                                </a>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer text-muted" th:if="${not #lists.isEmpty(employees)}">
            <small>Всего сотрудников: <span th:text="${#lists.size(employees)}"></span></small>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Функция подтверждения удаления
    function confirmDelete(form, firstName, lastName) {
        if (confirm('Вы уверены, что хотите удалить сотрудника "' + firstName + ' ' + lastName + '"?')) {
            return true;
        }
        return false;
    }

    // Увеличение QR-кода при клике
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.qr-code-img').forEach(img => {
            img.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Создаем модальное окно для увеличенного QR-кода
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
                modal.style.display = 'flex';
                modal.style.justifyContent = 'center';
                modal.style.alignItems = 'center';
                modal.style.zIndex = '9999';
                modal.style.cursor = 'pointer';

                const qrImage = document.createElement('img');
                qrImage.src = this.src;
                qrImage.style.maxWidth = '80%';
                qrImage.style.maxHeight = '80%';
                qrImage.style.border = '10px solid white';
                qrImage.style.borderRadius = '10px';
                qrImage.style.cursor = 'default';

                modal.appendChild(qrImage);

                // Закрытие при клике
                modal.addEventListener('click', function() {
                    document.body.removeChild(this);
                });

                document.body.appendChild(modal);
            });
        });

        // Проверяем статус синхронизации каждые 3 секунды
        checkAndAutoRefresh();
    });

    // Функция обновления страницы
    function refreshPage() {
        window.location.reload();
    }

    // Функция остановки синхронизации
    function stopSync() {
        if (confirm('Остановить текущую синхронизацию?')) {
            fetch('/employees/stop-sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Ошибка сети');
                })
                .then(message => {
                    alert(message);
                    // Обновляем страницу через секунду
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ошибка при остановке синхронизации: ' + error.message);
                });
        }
    }

    // Автообновление статуса если синхронизация выполняется
    function checkAndAutoRefresh() {
        const syncRunningElement = document.querySelector('.status-running');
        if (syncRunningElement) {
            // Обновляем страницу каждые 3 секунды если синхронизация выполняется
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }
    }
</script>
</body>
</html>